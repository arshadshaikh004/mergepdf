<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge PDF - Tools India Gup</title>
    <style>
        :root {
            --primary-color: #e53e3e;
            --primary-hover-color: #c53030;
            --background-color: #f7f7fb;
            --card-background: #ffffff;
            --text-color: #333;
            --secondary-text-color: #718096;
            --border-color: #e2e8f0;
            --transition-speed: 0.3s;
            --shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            height: 90vh;
            display: flex;
            flex-direction: column;
            line-height: 1.5;
            overflow: hidden;
        }

        /* Loaders & Progress Screen */
        .loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(247, 247, 251, 0.95);
            backdrop-filter: blur(5px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 1rem;
        }

        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        #loading-text {
            margin-top: 20px;
            font-size: 1.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        #upload-progress-overlay #upload-status-text {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        #upload-progress-overlay #upload-filename-text {
            color: var(--secondary-text-color);
            margin-bottom: 1.5rem;
            height: 1.2rem;
        }

        #upload-progress-overlay #upload-progress-bar-container {
            width: 100%;
            max-width: 400px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            height: 8px;
            margin-bottom: 1rem;
        }

        #upload-progress-overlay #upload-progress-bar {
            width: 0%;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.1s linear;
        }

        #upload-progress-overlay #upload-percentage {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 0rem;
            color: #000;
        }

        #upload-progress-overlay #upload-label {
            color: var(--secondary-text-color);
            letter-spacing: 2px;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        /* NEW: Stats for ETA and Speed */
        #processing-stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--secondary-text-color);
        }

        #processing-stats b {
            color: var(--text-color);
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .message-box {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 11000;
            max-width: 90%;
            text-align: center;
            color: #c62828;
            font-weight: 500;
        }

        .initial-screen,
        .post-merge-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            flex-grow: 1;
            width: 100%;
        }

        .post-merge-screen {
            display: none;
            justify-content: flex-start;
            overflow-y: auto;
        }

        .initial-screen {
            padding-bottom: 15vh;
        }

        .app-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .app-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .app-header p {
            font-size: 1.125rem;
            color: var(--secondary-text-color);
            max-width: 550px;
            margin: 1rem auto 0;
        }

        .drop-area {
            background: var(--card-background);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 4rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 600px;
        }

        .drop-area.drag-over {
            border-color: var(--primary-color);
            background-color: #fff5f5;
        }

        .drop-area p {
            margin-top: 1rem;
            color: var(--secondary-text-color);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color var(--transition-speed);
        }

        .btn-primary:hover {
            background: var(--primary-hover-color);
        }

        .file-selection-screen {
            display: none;
            flex-direction: row;
            flex-grow: 1;
            overflow: hidden;
        }

        .left-panel {
            flex: 1;
            background: #f7f7fb;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 28px 32px;
            padding: 70px 36px 36px 36px;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }

        .right-panel {
            border-left: 1px solid black;
            width: 30%;
            min-width: 380px;
            max-width: 450px;
            background: white;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 2;
            box-shadow: -8px 0px 25px -10px rgba(0, 0, 0, 0.1);
        }

        .right-panel h2 {
            text-align: center;
            margin: -24px -24px 15px -24px;
            padding: 24px 24px 15px 24px;
            border-bottom: 1px solid black;
        }

        #merge-info {
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 1rem;
            padding: 10px;
            border-radius: 6px;
            background: #f7f7fb;
        }

        #merge-info p {
            margin: 4px 0;
        }

        #merge-info b {
            font-weight: 600;
        }

        #merge-info .ready {
            color: #2f855a;
        }

        #merge-info .blocked {
            color: #c53030;
        }

        .file-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.09);
            padding: 10px;
            text-align: center;
            width: 200px;
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: grab;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .file-box:active {
            cursor: grabbing;
        }

        .file-box.file-box-locked,
        .file-box.file-box-corrupted {
            border-color: var(--primary-color);
        }

        .file-box.file-box-locked .action-btn.view-btn,
        .file-box.file-box-locked .action-btn.rotate-btn,
        .file-box.file-box-corrupted .action-btn.view-btn,
        .file-box.file-box-corrupted .action-btn.rotate-btn {
            display: none;
        }

        .file-status-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 54px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 7px;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .file-box-locked .file-status-overlay,
        .file-box-corrupted .file-status-overlay {
            display: flex;
        }

        .file-status-icon svg {
            width: 50px;
            height: 50px;
        }

        .file-box-loader {
            position: absolute;
            inset: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 7px;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .mini-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @media (hover: hover) {
            .file-box:hover {
                transform: translateY(-4px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
            }

            .file-box:hover .action-btn {
                opacity: 1;
                pointer-events: auto;
            }
        }

        .file-box canvas {
            width: 100%;
            height: 240px;
            border-radius: 7px;
            background: #f0f0f0;
            margin-bottom: 8px;
            object-fit: contain;
            border: 1px solid #e2e8f0;
        }

        .file-box-corrupted canvas {
            opacity: 0.5;
        }

        .file-box p.file-name {
            font-size: 13px;
            color: #333;
            word-break: break-all;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            height: 36px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .file-box .file-info {
            font-size: 12px;
            color: var(--secondary-text-color);
        }

        .action-btn {
            position: absolute;
            top: 6px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
        }

        .file-box .remove-btn {
            right: 6px;
        }

        .file-box .view-btn {
            right: 42px;
        }

        .file-box .rotate-btn {
            right: 78px;
        }

        .action-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .action-btn:hover svg {
            stroke: white;
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
            stroke: #333;
            stroke-width: 2.5;
            transition: stroke 0.2s;
        }

        .sortable-ghost {
            opacity: 0.4;
        }

        .sortable-chosen {
            border: 2px solid var(--primary-color);
        }

        .add-btn,
        .settings-btn,
        .remove-all-btn {
            position: fixed;
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
            border-radius: 50%;
        }

        .add-btn,
        .settings-btn {
            width: 40px;
            height: 40px;
        }

        .remove-all-btn {
            width: 30px;
            height: 30px;
        }

        .add-btn {
            top: 60px;
            right: 400px;
            background: var(--primary-color);
            font-size: 28px;
        }

        .settings-btn {
            top: 20px;
            right: 20px;
            background: white;
            color: black;
            font-size: 22px;
        }

        .remove-all-btn {
            top: 20px;
            left: 20px;
            background: #718096;
            font-size: 22px;
        }

        .merge-btn,
        .merge-btn-mobile {
            background: var(--primary-color);
            border: none;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .merge-btn:hover:not(:disabled),
        .merge-btn-mobile:hover:not(:disabled) {
            background: var(--primary-hover-color);
        }

        .merge-btn:disabled,
        .merge-btn-mobile:disabled {
            background: #e2e8f0;
            cursor: not-allowed;
            color: #a0aec0;
        }

        .post-merge-screen .app-header h1 {
            color: #333;
        }

        .result-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 1.5rem;
        }

        .btn-download {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            padding: 12px 24px;
            font-weight: bold;
            border-radius: 8px;
        }

        .back-arrow-btn,
        .side-action-btn {
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-arrow-btn:hover,
        .side-action-btn:hover {
            background: #cbd5e0;
        }

        .continue-to,
        .security-info {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            width: 100%;
            max-width: 700px;
            text-align: left;
        }

        .continue-to h3,
        .security-info h3 {
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .tool-grid a {
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .tool-grid a:hover {
            background: #f0f0f0;
        }

        .security-info {
            border: 1px solid #bce2ff;
            background: #f0f8ff;
            margin-bottom: 3rem;
        }

        .security-info p {
            color: var(--secondary-text-color);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            line-height: 1.6;
        }

        .security-info strong {
            color: var(--text-color);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 13000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 13001;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            text-align: center;
        }

        .modal h3 {
            margin-bottom: 8px;
            font-size: 1.25rem;
        }

        .modal p {
            margin-bottom: 16px;
            color: var(--secondary-text-color);
            line-height: 1.6;
            word-break: break-word;
        }

        .modal .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal .modal-actions button {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .pdf-viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 12000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .pdf-viewer-modal iframe {
            width: 100%;
            height: 100%;
            max-width: 90vw;
            max-height: 95vh;
            background: white;
            border: none;
            border-radius: 8px;
        }

        .pdf-viewer-close {
            position: absolute;
            top: 15px;
            right: 25px;
            background: none;
            border: none;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .add-btn {
                top: 100px;
                right: 15px;
                width: 44px;
                height: 44px;
                background: var(--primary-color);
                font-size: 28px;
            }

            .right-panel {
                position: fixed;
                top: 0;
                right: -100%;
                width: 90vw;
                max-width: 400px;
                min-width: 0;
                height: 100%;
                z-index: 1001;
                box-shadow: -4px 0 24px rgba(0, 0, 0, 0.18);
                transition: right 0.35s cubic-bezier(.4, 0, .2, 1);
            }

            .right-panel.open {
                right: 0;
                display: flex;
            }

            .right-panel .merge-btn {
                display: block;
                position: absolute;
                bottom: 20px;
                left: 20px;
                width: calc(100% - 40px);
            }

            .merge-btn-mobile {
                display: none;
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 40px);
                z-index: 100;
            }

            .add-btn,
            .remove-all-btn,
            .settings-btn {
                display: flex !important;
            }

            .tool-grid {
                grid-template-columns: 1fr;
            }

            .file-box .action-btn {
                opacity: 1;
                pointer-events: auto;
            }
        }

        @media (min-width: 769px) {
            .settings-btn {
                display: none !important;
            }

            .merge-btn-mobile {
                display: none !important;
            }
        }

        #right-panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #right-panel-overlay.active {
            display: block;
        }
    </style>
</head>

<body>
    <div id="loading-overlay" class="loader-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">Processing...</p>
    </div>

    <div id="upload-progress-overlay" class="loader-overlay">
        <p id="upload-status-text">Merging PDFs...</p>
        <p id="upload-filename-text"></p>
        <div id="upload-progress-bar-container">
            <div id="upload-progress-bar"></div>
        </div>
        <h2 id="upload-percentage">0%</h2>
        <p id="upload-label">MERGING</p>
        <div id="processing-stats">
            <span>Speed: <b id="processing-speed">--</b></span>
            <span>ETA: <b id="processing-eta">--:--</b></span>
        </div>
    </div>

    <div id="initial-screen" class="initial-screen">
        <header class="app-header">
            <h1>Merge PDF files</h1>
            <p>Combine PDFs in the order you want with the easiest PDF merger available.</p>
        </header>
        <div id="drop-area" class="drop-area"><button id="select-files-btn" class="btn-primary">Select PDF
                files</button>
            <p>or drop PDFs here</p>
        </div>
    </div>

    <div id="file-selection-screen" class="file-selection-screen">
        <div class="left-panel">
            <div id="file-list" class="file-list"></div>
            <button class="add-btn" title="Add more files">+</button>
            <button class="settings-btn" title="Settings">‚öôÔ∏è</button>
            <button class="remove-all-btn" title="Remove all files">üóëÔ∏è</button>
        </div>
        <div class="right-panel" id="rightPanel">
            <button id="close-right-panel"
                style="position:absolute;top:10px;left:10px;background:none;border:none;font-size:2rem;display:none;">&times;</button>
            <div>
                <h2>Merge Options</h2>
                <div id="merge-info"></div>
            </div>
            <button id="merge-btn" class="merge-btn" disabled><span>Merge PDF</span></button>
        </div>
    </div>
    <button class="merge-btn merge-btn-mobile" id="mergeBtnMobile" disabled><span>Merge PDF</span></button>

    <div id="post-merge-screen" class="post-merge-screen">
        <header class="app-header">
            <h1>PDFs have been merged!</h1>
        </header>
        <div class="result-actions">
            <button class="back-arrow-btn" id="back-arrow" title="Start Over"><svg width="24" height="24"
                    viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5" stroke="#333" stroke-width="2" stroke-linecap="round" />
                    <path d="M12 19l-7-7 7-7" stroke="#333" stroke-width="2" stroke-linecap="round" />
                </svg></button>
            <button id="download-btn" class="btn-primary btn-download"><svg width="24" height="24" viewBox="0 0 24 24"
                    fill="none">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="white"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>Download merged PDF</button>
            <div class="side-actions" style="display: flex; gap: 8px;">
                <button class="side-action-btn" id="delete-btn" title="Delete Merged File and Start Over"><svg
                        width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                            stroke="#e53e3e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg></button>
            </div>
        </div>
        <div class="continue-to">
            <h3>Continue to...</h3>
            <div class="tool-grid"><a href="#"><span>Compress PDF</span></a> <a href="#"><span>Split PDF</span></a><a
                    href="#"><span>Add watermark</span></a> <a href="#"><span>Rotate PDF</span></a></div>
        </div>
        <div class="security-info">
            <h3>Your Privacy Comes First. Always.</h3>
            <p>We believe your files are your own. This tool operates entirely within your browser. <strong>Nothing is
                    ever uploaded to our servers</strong>, ensuring your documents remain completely private and secure
                on your computer.</p>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>
    <div id="right-panel-overlay"></div>

    <div id="confirm-modal-overlay" class="modal-overlay"></div>
    <div id="confirm-modal" class="modal">
        <h3 id="confirm-title">Confirm Action</h3>
        <p id="confirm-message"></p>
        <div class="modal-actions">
            <button id="confirm-cancel-btn" class="btn-secondary">Cancel</button>
            <button id="confirm-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <div id="pdf-viewer-modal" class="pdf-viewer-modal">
        <button id="pdf-viewer-close" class="pdf-viewer-close">&times;</button>
        <iframe id="pdf-viewer-iframe" frameborder="0"></iframe>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

            const elements = {
                initialScreen: document.getElementById('initial-screen'), fileSelectionScreen: document.getElementById('file-selection-screen'),
                postMergeScreen: document.getElementById('post-merge-screen'), dropArea: document.getElementById('drop-area'),
                fileList: document.getElementById('file-list'), selectFilesBtn: document.getElementById('select-files-btn'),
                addBtn: document.querySelector('.add-btn'), settingsBtn: document.querySelector('.settings-btn'),
                removeAllBtn: document.querySelector('.remove-all-btn'), mergeBtn: document.getElementById('merge-btn'),
                mergeBtnMobile: document.getElementById('mergeBtnMobile'), rightPanel: document.getElementById('rightPanel'),
                closeRightPanelBtn: document.getElementById('close-right-panel'), rightPanelOverlay: document.getElementById('right-panel-overlay'),
                downloadBtn: document.getElementById('download-btn'), backArrowBtn: document.getElementById('back-arrow'),
                deleteBtn: document.getElementById('delete-btn'), messageBox: document.getElementById('message-box'),
                loadingOverlay: document.getElementById('loading-overlay'), loadingText: document.getElementById('loading-text'),
                mergeInfo: document.getElementById('merge-info'),
                uploadProgressOverlay: document.getElementById('upload-progress-overlay'),
                uploadProgressBar: document.getElementById('upload-progress-bar'),
                uploadPercentage: document.getElementById('upload-percentage'),
                uploadStatusText: document.getElementById('upload-status-text'),
                uploadFilenameText: document.getElementById('upload-filename-text'),
                processingSpeed: document.getElementById('processing-speed'),
                processingEta: document.getElementById('processing-eta'),
                confirmModalOverlay: document.getElementById('confirm-modal-overlay'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmTitle: document.getElementById('confirm-title'),
                confirmMessage: document.getElementById('confirm-message'),
                confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
                confirmOkBtn: document.getElementById('confirm-ok-btn'),
                pdfViewerModal: document.getElementById('pdf-viewer-modal'),
                pdfViewerIframe: document.getElementById('pdf-viewer-iframe'),
                pdfViewerClose: document.getElementById('pdf-viewer-close'),
            };

            const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'application/pdf'; fileInput.multiple = true; fileInput.style.display = 'none'; document.body.appendChild(fileInput);
            let filesData = []; let pageRotations = {}; let fileIdCounter = 0; let currentViewerUrl = null;

            const showScreen = (screen) => {
                elements.initialScreen.style.display = 'none'; elements.fileSelectionScreen.style.display = 'none'; elements.postMergeScreen.style.display = 'none';
                screen.style.display = 'flex';
                const isSelection = screen === elements.fileSelectionScreen;
                [elements.addBtn, elements.settingsBtn, elements.removeAllBtn].forEach(btn => btn.style.display = isSelection ? 'flex' : 'none');
                updateMergeButtonState();
            };

            const showLoader = (text) => { elements.loadingText.textContent = text; elements.loadingOverlay.style.display = 'flex'; };
            const hideLoader = () => { elements.loadingOverlay.style.display = 'none'; };
            const showMessage = (text) => { elements.messageBox.textContent = text; elements.messageBox.style.display = 'block'; setTimeout(() => { elements.messageBox.style.display = 'none'; }, 4000); };
            const formatBytes = (bytes, decimals = 2) => {
                if (bytes === 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
            const updateMergeButtonState = () => {
                const readyFiles = filesData.filter(f => f.status === 'ready');
                const lockedFiles = filesData.filter(f => f.status === 'locked');
                const corruptedFiles = filesData.filter(f => f.status === 'corrupted');
                const canMerge = readyFiles.length >= 2;
                elements.mergeBtn.disabled = !canMerge;
                elements.mergeBtnMobile.disabled = !canMerge;
                let infoHTML = `<p class="ready"><b>${readyFiles.length}</b> file(s) ready for merge.</p>`;
                if (lockedFiles.length > 0) { infoHTML += `<p class="blocked"><b>${lockedFiles.length}</b> file(s) are locked and will be ignored.</p>`; }
                if (corruptedFiles.length > 0) { infoHTML += `<p class="blocked"><b>${corruptedFiles.length}</b> file(s) are corrupted and will be ignored.</p>`; }
                if (filesData.length > 0 && !canMerge) { infoHTML += `<p>At least 2 valid files are needed to merge.</p>` }
                elements.mergeInfo.innerHTML = infoHTML;
                const isMobileView = window.innerWidth <= 768;
                if (isMobileView) { elements.mergeBtnMobile.style.display = filesData.length > 0 ? 'block' : 'none'; }
                else { elements.mergeBtnMobile.style.display = 'none'; }
            };

            const resetApp = () => {
                filesData = []; pageRotations = {}; fileIdCounter = 0;
                elements.fileList.innerHTML = ''; window.mergedPdfBlob = null;
                showScreen(elements.initialScreen);
                toggleRightPanel(true);
            };

            const showConfirmation = (message, title = 'Confirm Action') => {
                return new Promise(resolve => {
                    elements.confirmModalOverlay.style.display = 'block';
                    elements.confirmModal.style.display = 'block';
                    elements.confirmTitle.textContent = title;
                    elements.confirmMessage.innerHTML = message;
                    const handleOk = () => { cleanup(); resolve(true); };
                    const handleCancel = () => { cleanup(); resolve(false); };
                    elements.confirmOkBtn.addEventListener('click', handleOk);
                    elements.confirmCancelBtn.addEventListener('click', handleCancel);
                    elements.confirmModalOverlay.addEventListener('click', handleCancel);
                    function cleanup() {
                        elements.confirmModalOverlay.style.display = 'none';
                        elements.confirmModal.style.display = 'none';
                        elements.confirmOkBtn.removeEventListener('click', handleOk);
                        elements.confirmCancelBtn.removeEventListener('click', handleCancel);
                        elements.confirmModalOverlay.removeEventListener('click', handleCancel);
                    }
                });
            };

            const processAndAddFile = async (file) => {
                let fileObject = { id: fileIdCounter++, file: file, pageCount: 0, status: 'corrupted', pdfDoc: null };
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
                    fileObject.status = 'ready';
                    fileObject.pageCount = pdfDoc.numPages;
                    fileObject.pdfDoc = pdfDoc;
                } catch (e) {
                    if (e.name === 'PasswordException') { fileObject.status = 'locked'; }
                    console.error(`Could not process ${file.name}:`, e.name);
                }
                filesData.push(fileObject);
                renderFileBox(fileObject);
            };

            const addFilesToList = async (files) => {
                const filesToProcess = [];
                for (const file of files) {
                    if (file.type !== 'application/pdf') { showMessage(`'${file.name}' is not a PDF.`); continue; }
                    const isDuplicate = filesData.some(f => f.file.name === file.name);
                    if (isDuplicate) {
                        const userConfirmed = await showConfirmation(`A file named "<b>${file.name}</b>" is already in the list.<br><br>Do you want to add it again?`, "Duplicate File");
                        if (userConfirmed) { filesToProcess.push(file); }
                    } else { filesToProcess.push(file); }
                }
                if (filesToProcess.length === 0) { fileInput.value = ''; return; }
                showLoader('Checking files...');
                for (const file of filesToProcess) { await processAndAddFile(file); }
                hideLoader();
                if (filesData.length > 0) { showScreen(elements.fileSelectionScreen); }
                updateMergeButtonState();
                fileInput.value = '';
            };

            const renderFileBox = (fileObject) => {
                const fileBox = document.createElement('div');
                fileBox.className = 'file-box'; fileBox.dataset.id = fileObject.id;
                let statusIcon = '';
                if (fileObject.status === 'locked') {
                    fileBox.classList.add('file-box-locked');
                    statusIcon = `<svg fill="#333" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>`;
                } else if (fileObject.status === 'corrupted') {
                    fileBox.classList.add('file-box-corrupted');
                    statusIcon = `<svg fill="#c53030" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>`;
                }
                fileBox.innerHTML = `
                <div class="file-status-overlay"><div class="file-status-icon">${statusIcon}</div></div>
                <div class="file-box-loader"><div class="mini-spinner"></div></div>
                <canvas></canvas> 
                <p class="file-name" title="${fileObject.file.name}">${fileObject.file.name}</p>
                <div class="file-info">${formatBytes(fileObject.file.size)} ${fileObject.pageCount > 0 ? '‚Ä¢ ' + fileObject.pageCount + ' page(s)' : ''}</div>
                <button class="rotate-btn action-btn" title="Rotate Document"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1  14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></button>
                <button class="view-btn action-btn" title="View Document"><svg viewBox="0 0 24 24" fill="none"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                <button class="remove-btn action-btn" title="Remove Document"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></button>`;
                elements.fileList.appendChild(fileBox);
                if (fileObject.status === 'ready') { renderPDFPreview(fileObject, fileBox.querySelector('canvas')); }
            };

            const removeFileById = (idToRemove) => {
                const index = filesData.findIndex(f => f.id === idToRemove);
                if (index > -1) { filesData.splice(index, 1); const fileBox = elements.fileList.querySelector(`.file-box[data-id='${idToRemove}']`); if (fileBox) fileBox.remove(); updateMergeButtonState(); if (filesData.length === 0) resetApp(); }
            };

            const renderPDFPreview = async (fileObject, canvas) => {
                const rotation = pageRotations[`${fileObject.id}-1`] || 0;
                try {
                    const pdf = fileObject.pdfDoc;
                    if (!pdf) { console.error("PDF document not found in cache for preview."); return; }
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 1.5, rotation });
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                } catch (e) { console.error(`Preview error for ${fileObject.file.name}:`, e); }
            };

            const reorderSelectedFiles = () => { filesData = Array.from(elements.fileList.children).map(box => filesData.find(f => f.id === parseInt(box.dataset.id, 10))); };

            // --- UPDATED MERGE FUNCTION WITH PROGRESS BAR, ETA, AND TIMING ---
            const mergePdfs = async () => {
                const readyFiles = filesData.filter(f => f.status === 'ready');
                if (readyFiles.length < 2) { showMessage("Not enough valid files to merge."); return; }

                let currentProgress = 0;
                const animateProgress = (targetPercentage) => {
                    return new Promise(resolve => {
                        const interval = setInterval(() => {
                            if (currentProgress >= targetPercentage) { clearInterval(interval); resolve(); }
                            else {
                                currentProgress++;
                                elements.uploadProgressBar.style.width = `${currentProgress}%`;
                                elements.uploadPercentage.textContent = `${currentProgress}%`;
                            }
                        }, 25);
                    });
                };

                const formatSpeed = (bytesPerMs) => {
                    if (!bytesPerMs || bytesPerMs <= 0) return "--";
                    const mbps = (bytesPerMs * 1000) / (1024 * 1024);
                    return mbps.toFixed(2) + " MB/s";
                };

                const formatEta = (ms) => {
                    if (!ms || ms === Infinity || ms <= 0) return "--:--";
                    const totalSeconds = Math.round(ms / 1000);
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                };

                const startTime = Date.now();
                elements.uploadProgressOverlay.style.display = 'flex';
                elements.uploadStatusText.textContent = `Merging ${readyFiles.length} files...`;
                elements.uploadFilenameText.textContent = "";
                elements.uploadProgressBar.style.width = '0%';
                elements.uploadPercentage.textContent = '0%';
                elements.processingSpeed.textContent = "--";
                elements.processingEta.textContent = "--:--";

                try {
                    const { PDFDocument } = window.PDFLib;
                    const mergedPdf = await PDFDocument.create();
                    const totalSize = readyFiles.reduce((acc, f) => acc + f.file.size, 0);
                    let bytesProcessed = 0;

                    for (let i = 0; i < readyFiles.length; i++) {
                        const fileObject = readyFiles[i];
                        elements.uploadFilenameText.textContent = `Processing: ${fileObject.file.name}`;

                        const arrayBuffer = await fileObject.file.arrayBuffer();
                        const pdfToMerge = await PDFDocument.load(arrayBuffer);
                        const copiedPages = await mergedPdf.copyPages(pdfToMerge, pdfToMerge.getPageIndices());

                        copiedPages.forEach((page, pageIndex) => {
                            const rotation = pageRotations[`${fileObject.id}-${pageIndex + 1}`] || 0;
                            if (rotation !== 0) page.setRotation(window.PDFLib.degrees(rotation));
                            mergedPdf.addPage(page);
                        });

                        bytesProcessed += fileObject.file.size;
                        const elapsedTime = Date.now() - startTime;
                        const speed = bytesProcessed / elapsedTime;
                        const eta = (totalSize - bytesProcessed) / speed;

                        elements.processingSpeed.textContent = formatSpeed(speed);
                        elements.processingEta.textContent = formatEta(eta);

                        const targetPercentage = (bytesProcessed / totalSize) * 95; // Process up to 95%
                        await animateProgress(targetPercentage);
                    }

                    elements.uploadFilenameText.textContent = 'Finalizing PDF...';
                    const mergedPdfBytes = await mergedPdf.save();
                    window.mergedPdfBlob = new Blob([mergedPdfBytes], { type: 'application/pdf' });

                    const elapsedTime = Date.now() - startTime;
                    const minTime = 5000; // Minimum 5 seconds
                    if (elapsedTime < minTime) {
                        await new Promise(res => setTimeout(res, minTime - elapsedTime));
                    }

                    await animateProgress(100);

                    elements.uploadProgressOverlay.style.display = 'none';
                    showLoader('Success!');
                    await new Promise(res => setTimeout(res, 2500));
                    hideLoader();
                    showScreen(elements.postMergeScreen);

                } catch (error) {
                    console.error(error);
                    elements.uploadProgressOverlay.style.display = 'none';
                    showMessage('Merge failed. A file might be corrupted.');
                }
            };

            fileInput.addEventListener('change', (e) => addFilesToList(e.target.files));
            elements.selectFilesBtn.addEventListener('click', () => fileInput.click());
            elements.addBtn.addEventListener('click', () => fileInput.click());
            elements.removeAllBtn.addEventListener('click', resetApp);
            elements.dropArea.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
            elements.dropArea.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over'));
            elements.dropArea.addEventListener('drop', (e) => { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); addFilesToList(e.dataTransfer.files); });
            let isDragging = false;
            elements.fileList.addEventListener('touchstart', () => { isDragging = false; }, { passive: true });
            elements.fileList.addEventListener('touchmove', () => { isDragging = true; }, { passive: true });
            elements.fileList.addEventListener('touchend', async (e) => { if (isDragging) return; handleActionClick(e); });
            elements.fileList.addEventListener('click', (e) => { if (e.pointerType !== 'touch') { handleActionClick(e); } });

            async function handleActionClick(e) {
                const target = e.target.closest('button.action-btn'); if (!target) return;
                e.preventDefault(); e.stopPropagation();
                const fileBox = target.closest('.file-box'); const fileId = parseInt(fileBox.dataset.id, 10);
                const fileObject = filesData.find(f => f.id === fileId);
                if (!fileObject) return;
                if (target.classList.contains('remove-btn')) { removeFileById(fileId); }
                else if (target.classList.contains('view-btn') && fileObject.status === 'ready') {
                    const isMobile = window.innerWidth <= 768;
                    const fileUrl = URL.createObjectURL(fileObject.file);
                    if (isMobile) { window.open(fileUrl, '_blank'); }
                    else {
                        if (currentViewerUrl) URL.revokeObjectURL(currentViewerUrl);
                        currentViewerUrl = fileUrl;
                        elements.pdfViewerIframe.src = currentViewerUrl;
                        elements.pdfViewerModal.style.display = 'flex';
                    }
                } else if (target.classList.contains('rotate-btn') && fileObject.status === 'ready') {
                    const loader = fileBox.querySelector('.file-box-loader');
                    loader.style.display = 'flex';
                    try {
                        const pageCount = fileObject.pageCount;
                        for (let i = 1; i <= pageCount; i++) { pageRotations[`${fileObject.id}-${i}`] = ((pageRotations[`${fileObject.id}-${i}`] || 0) + 90) % 360; }
                        await renderPDFPreview(fileObject, fileBox.querySelector('canvas'));
                    } catch (err) { showMessage("Couldn't rotate file."); }
                    finally { loader.style.display = 'none'; }
                }
            }

            elements.pdfViewerClose.addEventListener('click', () => {
                elements.pdfViewerModal.style.display = 'none'; elements.pdfViewerIframe.src = '';
                if (currentViewerUrl) { URL.revokeObjectURL(currentViewerUrl); currentViewerUrl = null; }
            });

            [elements.mergeBtn, elements.mergeBtnMobile].forEach(btn => btn.addEventListener('click', mergePdfs));
            elements.downloadBtn.addEventListener('click', () => {
                if (window.mergedPdfBlob) { const url = URL.createObjectURL(window.mergedPdfBlob); const a = document.createElement('a'); a.href = url; a.download = 'Tools-India-Gup-merged.pdf'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
            });
            [elements.backArrowBtn, elements.deleteBtn].forEach(btn => btn.addEventListener('click', resetApp));
            const toggleRightPanel = (forceClose = false) => {
                const isOpen = elements.rightPanel.classList.contains('open');
                if (forceClose || isOpen) { elements.rightPanel.classList.remove('open'); elements.rightPanelOverlay.classList.remove('active'); } else { elements.rightPanel.classList.add('open'); elements.rightPanelOverlay.classList.add('active'); }
                elements.closeRightPanelBtn.style.display = elements.rightPanel.classList.contains('open') ? 'block' : 'none';
            };
            elements.settingsBtn.addEventListener('click', () => toggleRightPanel());
            elements.closeRightPanelBtn.addEventListener('click', () => toggleRightPanel(true));
            elements.rightPanelOverlay.addEventListener('click', () => toggleRightPanel(true));
            window.addEventListener('resize', updateMergeButtonState);
            new Sortable(elements.fileList, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', filter: '.action-btn', preventOnFilter: false, onEnd: reorderSelectedFiles });
            showScreen(elements.initialScreen);
        });
    </script>
</body>

</html>